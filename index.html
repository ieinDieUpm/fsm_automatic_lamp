<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FSM automatic lamp: Sistema de iluminación automática</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FSM automatic lamp
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Sistema de iluminación automática </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Este proyecto implementa un sistema de iluminación automática con un sensor LDR y 2 LEDs. El sistema utiliza una FSM para gestionar los diferentes estados del sistema y el hardware. La configuración HW se muestra en la siguiente imagen:</p>
<div class="image">
<img src="fsm_automatic_lamp_bb.png" alt=""/>
<div class="caption">
HW iluminación automática</div></div>
   <p>El sistema usa una FSM para gestionar los diferentes estados del sistema y el hardware. Esta imagen muestra la FSM del sistema:</p>
<div class="image">
<img src="fsm_automatic_lamp.png" alt=""/>
<div class="caption">
FSM iluminación automática</div></div>
   <p>El sistema toma una medida cada vez que se activa su temporizador. La medida se realiza mediante el periférico ADC. El ADC está configurado para muestrear el sensor LDR en modo único. El temporizador está configurado en el archivo <code>PORT</code> del sistema.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Define label </td><td class="markdownTableBodyNone">AUTOMATIC_LAMP_MEASUREMENT_TIMER  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Timer </td><td class="markdownTableBodyNone">TIM3  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Interrupt </td><td class="markdownTableBodyNone">TIM3_IRQHandler()  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time interval </td><td class="markdownTableBodyNone">1 second  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">2  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<p>Puede generar tantos sistemas de iluminación como desee creando una nueva FSM y asignando los periféricos correspondientes al sistema. El sistema está implementado en el archivo <code><a class="el" href="main_8c.html" title="Basic FSM reading analog data from an LDR sensor and controlling a LED.">main.c</a></code>.</p>
<p>Puede acceder al código fuente del proyecto en el siguiente enlace: <a href="https://github.com/ieinDieUpm/fsm_automatic_lamp">Sistema de iluminación automática con FSM y ADC</a>.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Implementación HW</h1>
<h1><a class="anchor" id="autotoc_md4"></a>
Sensor LDR</h1>
<p>El sensor LDR utilizado en el sistema es el NSL-19M51 (ver <a href="https://docs.rs-online.com/7251/0900766b8156674e.pdf">hoja de datos del NSL-19M51</a>). El sensor está ubicado en la <em>shield</em> proporcionado por la universidad. El sensor está conectado con una resistencia de <em>pull-down</em> en el circuito como se muestra en la siguiente imagen:</p>
<div class="image">
<img src="ldr_shield.png" alt=""/>
<div class="caption">
Circuito LDR</div></div>
   <p>El sensor se muestrea en modo único con un período de muestreo dado por las interrupciones de un temporizador. Todas las configuraciones del ADC son por defecto. El ADC está configurado para interrumpir cuando la conversión se completa. El ADC está configurado como indica la siguiente tabla:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">ldr_sensor_lamp  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone"><b>Por determinar</b> (A1 Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC </td><td class="markdownTableBodyNone"><b>Por determinar</b>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Channel </td><td class="markdownTableBodyNone"><b>Por determinar</b>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ISR </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a06406eadf297fa89a6eaf9586b227a69" title="Interrupt service routine for all the ADCs.">ADC_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md5"></a>
LEDs</h1>
<p>Hay 2 LEDs para indicar el estado del sistema. Un <b>LED verde</b> (<code>led_status</code>) se utiliza para indicar que el sistema está funcionando cuando la luz no está encendida. Un <b>LED rojo</b> (<code>led_lamp</code>) que hace las veces de la luz del sistema.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">led_status  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PA5 (LD2 on Nucleo board)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Output  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">led_lamp  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PB4 (D5 on Nucleo and shield)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Output  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md6"></a>
Funcionamiento detallado del sistema</h1>
<p>El sistema está codificado según el diagrama de estados mostrado anteriormente. El sistema se comporta de la siguiente manera:</p>
<ul>
<li>El sistema se inicia en el estado <code>LAMP_OFF</code>. En este estado, el LED <code>led_status</code> está encendido y <code>led_lamp</code> está apagado.</li>
<li>Cada vez que salta la ISR del temporizador, el sistema llama a <code><a class="el" href="port__system_8h.html#a930f7527b31962044dc8cf0244c68431" title="Start the conversion of the ADC peripheral.">port_system_adc_start_conversion()</a></code> para iniciar una conversión del sensor LDR. La ISR del ADC se activa cuando la conversión se completa (bit <code>EOC</code>). En la ISR del ADC, el sistema llama a <code><a class="el" href="port__ldr__sensor_8h.html#afcfb1bd745fa453a240e131674de1054" title="Saves the ADC value of the LDR sensor and converts it to Ohms.">port_ldr_sensor_save_adc_value()</a></code> para gestionar el valor del sensor LDR. Esta función guarda el valor de impedancia del sensor LDR en la variable <code>resistance_ohms</code> del <code>ldr_sensor_lamp</code>.</li>
<li>El sistema comprueba (<code><a class="el" href="fsm__automatic__lamp_8c.html#a7867a8f9e967d5da8d38c324d28158a6" title="Check if the value of impedance of the LDR is low enough to activate the automatic lamp.">check_on()</a></code>) si el valor de impedancia del sensor cruza el umbral establecido en el campo <code>threshold_ldr_ohms</code> de <code>ldr_sensor_lamp</code>. En el <a class="el" href="md_ejercicio.html">ejercicio</a> deberá identificar si el umbral se cruza en el sentido de que el valor de impedancia del sensor LDR es mayor o menor que el umbral.</li>
<li>Si se cruza el umbral, el sistema cambia al estado <code>LAMP_ON</code>. En este estado, el LED <code>led_lamp</code> se enciende y el LED <code>led_status</code> se apaga.</li>
<li>De manera análoga, en el estado <code>LAMP_ON</code>, el sistema comprueba (<code><a class="el" href="fsm__automatic__lamp_8c.html#a44c28497a4aab5947a265a7a75314135" title="Check if the value of impedance of the LDR is high enough to deactivate the automatic lamp.">check_off()</a></code>) si el valor de impedancia del sensor LDR cruza el umbral establecido en el campo <code>threshold_ldr_ohms</code> de <code>ldr_sensor_lamp</code>. Si se cruza el umbral, vuelve al estado <code>LAMP_OFF</code>, el LED <code>led_status</code> se enciende y el LED <code>led_lamp</code> se apaga.</li>
</ul>
<blockquote class="doxtable">
<p>[!WARNING] Si desea utilizar la función <code>printf()</code> utilizando el SW debe comentar la línea <code>#define DISABLE_SWO</code> en el archivo <code><a class="el" href="main_8c.html" title="Basic FSM reading analog data from an LDR sensor and controlling a LED.">main.c</a></code>. En este caso, <b>si está utilizando la placa proporcionada por la universidad, el pin <code>PB3</code> estará activo encendiendo el verde del RGB constantemente y no verá el LED rojo puro sino una mezcla con el verde en su lugar.</b> </p>
</blockquote>
<p>Mire la siguiente imagen para ver la <em>shield</em> donde se encuentra el LED rojo y el sensor LDR:</p>
<div class="image">
<img src="shield.png" alt=""/>
<div class="caption">
Shield</div></div>
   <h1><a class="anchor" id="autotoc_md7"></a>
Referencias</h1>
<ul>
<li><b>[1]</b>: <a href="https://moodle.upm.es/titulaciones/oficiales/course/view.php?id=785#section-0">Documentation available in the Moodle of the course</a></li>
<li><b>[2]</b>: <a href="https://web.eece.maine.edu/~zhu/book/index.php">Embedded Systems with ARM Cortex-M Microcontrollers in Assembly Language and C (Fourth Edition)</a> for explanations and examples of use of the ARM Cortex-M microcontrollers in C with CMSIS.</li>
<li><b>[3]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA51126621660004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;tab=tab1&amp;query=any,contains,Programming%20with%20STM32:%20Getting%20Started%20with%20the%20Nucleo%20Board%20and%20C%2FC%2B%2B&amp;offset=0">Programming with STM32: Getting Started with the Nucleo Board and C/C++</a> for examples of use of the STM32 microcontrollers with the HAL of ST.</li>
<li><b>[4]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA2151866130004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;isFrbr=true&amp;tab=tab1&amp;query=any,contains,C%20Programming%20Language">The C Programming Language</a></li>
<li><b>[5]</b>: <a href="https://www.elektor.com/products/nucleo-boards-programming-with-the-stm32cubeide">Nucleo Boards Programming with th STM32CubeIDE</a> for examples of use of the STM32 microcontrollers with the STM32CubeIDE. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
